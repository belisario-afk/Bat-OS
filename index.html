<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BAT-OS | STABLE MEDIA</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <style>
        :root { --glow: #ff3c00; --bg: #000; }
        body { margin: 0; overflow: hidden; background: var(--bg); font-family: 'Courier New', monospace; color: var(--glow); user-select: none; }
        #intro { position: fixed; inset: 0; z-index: 1000; cursor: pointer; display: flex; justify-content: center; align-items: center; background: #000; }
        .door { position: absolute; top: 0; height: 100%; width: 50.5%; background: #050505; border: 1px solid #111; transition: transform 2s cubic-bezier(0.8, 0, 0.2, 1); z-index: 1001; }
        #left-door { left: 0; } #right-door { right: 0; }
        .open #left-door { transform: translateX(-100%); }
        .open #right-door { transform: translateX(100%); }
        #scan-box { display: none; position: relative; z-index: 1002; text-align: center; }
        #laser { width: 250px; height: 3px; background: var(--glow); box-shadow: 0 0 20px var(--glow); position: absolute; animation: moveLaser 1.5s ease-in-out infinite; }
        @keyframes moveLaser { 0%, 100% { top: 0; } 50% { top: 250px; } }
        #hud { position: absolute; inset: 0; pointer-events: none; z-index: 10; opacity: 0; transition: opacity 1.5s; }
        canvas { display: block; }
        #screenContent { display: none; }
    </style>
</head>
<body>

<div id="intro">
    <div id="left-door" class="door"></div>
    <div id="right-door" class="door"></div>
    <div id="scan-box">
        <div id="laser"></div>
        <p style="margin-top:280px; font-weight: bold; letter-spacing: 5px;" id="auth-status">DECRYPTING MEDIA STRATA...</p>
    </div>
    <div id="tap-msg" style="z-index:1003; font-size: 18px; border: 1px solid var(--glow); padding: 10px 20px;">[ INITIALIZE SYSTEM ]</div>
</div>

<div id="hud">
    <div style="position:absolute; top:20px; left:30px; font-size:12px;">ENCRYPTION: ACTIVE | MEDIA_DEVICE: BAT-OS</div>
</div>

<canvas id="screenContent" width="1024" height="512"></canvas>

<script src="https://sdk.scdn.co/spotify-player.js"></script>

<script type="importmap">
  { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
</script>

<script type="module">
    import * as THREE from 'three';

    const CLIENT_ID = '2a31097ec0e64dc99ba46002bac64623';
    const REDIRECT_URI = 'https://belisario-afk.github.io/Bat-OS/'; 
    const SCOPES = 'streaming user-read-currently-playing user-modify-playback-state user-read-playback-state';

    let spotifyToken = localStorage.getItem('access_token');
    let currentTrack = "IDLE";
    let currentArtist = "WAITING...";
    let albumImg = new Image();
    albumImg.crossOrigin = "anonymous";
    let albumLoaded = false;
    let progressMs = 0;
    let durationMs = 1;
    let batteryLevel = "0%";
    let dashReady = false;
    let playerInstance;

    // --- PKCE CRYPTO ---
    const generateRandomString = (l) => {
        const p = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
        return [...crypto.getRandomValues(new Uint8Array(l))].map(x => p[x % p.length]).join('');
    };
    const sha256 = async (plain) => {
        const encoder = new TextEncoder();
        const data = encoder.encode(plain);
        return window.crypto.subtle.digest('SHA-256', data);
    };
    const base64encode = (input) => {
        return btoa(String.fromCharCode.apply(null, new Uint8Array(input))).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    };

    // --- AUTH ---
    async function handleAuth() {
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');
        if (code) {
            document.getElementById('intro').style.display = 'none';
            const codeVerifier = localStorage.getItem('code_verifier');
            const params = new URLSearchParams({
                client_id: CLIENT_ID, grant_type: 'authorization_code',
                code: code, redirect_uri: REDIRECT_URI, code_verifier: codeVerifier,
            });
            const res = await fetch('https://accounts.spotify.com/api/token', {
                method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: params
            });
            const data = await res.json();
            if (data.access_token) {
                localStorage.setItem('access_token', data.access_token);
                window.location.href = REDIRECT_URI; 
            }
            return true;
        }
        return false;
    }

    async function redirectToSpotify() {
        const verifier = generateRandomString(64);
        const challenge = base64encode(await sha256(verifier));
        localStorage.setItem('code_verifier', verifier);
        const params = new URLSearchParams({
            response_type: 'code', client_id: CLIENT_ID, scope: SCOPES,
            code_challenge_method: 'S256', code_challenge: challenge, redirect_uri: REDIRECT_URI,
        });
        window.location.href = `https://accounts.spotify.com/authorize?${params.toString()}`;
    }

    // --- WEB PLAYER SDK ---
    window.onSpotifyWebPlaybackSDKReady = () => {
        if (!spotifyToken) return;
        playerInstance = new Spotify.Player({
            name: 'Batmobile Tactical OS',
            getOAuthToken: cb => { cb(spotifyToken); },
            volume: 0.8
        });

        playerInstance.addListener('ready', ({ device_id }) => {
            console.log('Player Ready:', device_id);
            fetch('https://api.spotify.com/v1/me/player', {
                method: 'PUT',
                headers: { 'Authorization': `Bearer ${spotifyToken}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ device_ids: [device_id], play: false })
            });
        });

        playerInstance.addListener('player_state_changed', state => {
            if (!state) return;
            currentTrack = state.track_window.current_track.name.toUpperCase();
            currentArtist = state.track_window.current_track.artists[0].name.toUpperCase();
            progressMs = state.position;
            durationMs = state.duration;
            
            const newArtUrl = state.track_window.current_track.album.images[0].url;
            if (albumImg.src !== newArtUrl) {
                albumLoaded = false;
                albumImg.src = newArtUrl;
                albumImg.onload = () => { albumLoaded = true; };
            }
        });

        playerInstance.connect();
    };

    // --- THREE.JS ---
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(50, window.innerWidth/window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);
    const dashGroup = new THREE.Group();
    scene.add(dashGroup);

    const screenCanvas = document.getElementById('screenContent');
    const ctx = screenCanvas.getContext('2d');
    const screenTexture = new THREE.CanvasTexture(screenCanvas);
    const monitor = new THREE.Mesh(new THREE.PlaneGeometry(8, 4), new THREE.MeshStandardMaterial({ map: screenTexture, emissive: 0xff3c00, emissiveIntensity: 0.25 }));
    monitor.position.z = 0.2; dashGroup.add(monitor);

    const buttons = [];
    const controls = [{ sym: '|<', x: -5.5, y: 1.5, cmd: 'prev' }, { sym: '||', x: -5.5, y: 0, cmd: 'toggle' }, { sym: '>|', x: -5.5, y: -1.5, cmd: 'next' }];
    controls.forEach(cfg => {
        const btn = new THREE.Mesh(new THREE.BoxGeometry(1.2, 0.8, 0.3), new THREE.MeshStandardMaterial({ color: 0x111111, emissive: 0xff3c00, emissiveIntensity: 0.1 }));
        btn.position.set(cfg.x, cfg.y, 0.3);
        const lCanvas = document.createElement('canvas'); lCanvas.width = 64; lCanvas.height = 64;
        const lCtx = lCanvas.getContext('2d'); lCtx.fillStyle = '#ff3c00'; lCtx.font = 'bold 30px Arial'; lCtx.textAlign = 'center'; lCtx.fillText(cfg.sym, 32, 45);
        const labelMesh = new THREE.Mesh(new THREE.PlaneGeometry(0.6, 0.6), new THREE.MeshBasicMaterial({ map: new THREE.CanvasTexture(lCanvas), transparent: true }));
        labelMesh.position.set(cfg.x, cfg.y, 0.46);
        btn.userData = { cmd: cfg.cmd }; buttons.push(btn); dashGroup.add(btn, labelMesh);
    });

    scene.add(new THREE.PointLight(0xff3c00, 25, 20));
    camera.position.z = 10;

    window.addEventListener('pointerdown', (e) => {
        if (!dashReady) return;
        const mouse = new THREE.Vector2((e.clientX / window.innerWidth) * 2 - 1, -(e.clientY / window.innerHeight) * 2 + 1);
        const raycaster = new THREE.Raycaster();
        raycaster.setFromCamera(mouse, camera);
        const hit = raycaster.intersectObjects(buttons);
        if(hit.length > 0) {
            const b = hit[0].object; b.position.z = 0.1;
            if (b.userData.cmd === 'toggle') playerInstance.togglePlay();
            if (b.userData.cmd === 'next') playerInstance.nextTrack();
            if (b.userData.cmd === 'prev') playerInstance.previousTrack();
            setTimeout(() => b.position.z = 0.3, 150);
        }
    });

    // Boot Logic
    const isProcessingCode = await handleAuth();
    if (!isProcessingCode && spotifyToken) {
        dashReady = true;
        document.getElementById('intro').style.display = 'none';
        document.getElementById('hud').style.opacity = 1;
    }

    document.getElementById('intro').onclick = () => {
        if(dashReady || isProcessingCode) return;
        document.getElementById('intro').classList.add('open');
        document.getElementById('scan-box').style.display = 'block';
        document.getElementById('scan-box').style.opacity = 1;
        document.getElementById('tap-msg').style.display = 'none';
        setTimeout(redirectToSpotify, 3000);
    };

    if (navigator.getBattery) { navigator.getBattery().then(batt => { 
        batteryLevel = Math.floor(batt.level * 100) + "%";
        batt.onlevelchange = () => batteryLevel = Math.floor(batt.level * 100) + "%";
    }); }

    function draw() {
        ctx.fillStyle = 'black'; ctx.fillRect(0, 0, 1024, 512);
        ctx.strokeStyle = '#ff3c00'; ctx.lineWidth = 4; ctx.strokeRect(20, 20, 984, 472);
        
        // Album Art Render
        if (albumLoaded) {
            ctx.drawImage(albumImg, 60, 100, 320, 320);
            ctx.strokeStyle = '#ff3c00'; ctx.lineWidth = 2; ctx.strokeRect(60, 100, 320, 320);
        } else {
            ctx.fillStyle = '#111'; ctx.fillRect(60, 100, 320, 320);
            ctx.fillStyle = '#ff3c00'; ctx.font = '20px Courier'; ctx.fillText("LOADING ART...", 140, 260);
        }

        ctx.fillStyle = '#ff3c00';
        ctx.font = 'bold 32px Courier'; ctx.fillText("WAYNETECH TACTICAL MEDIA", 450, 80);
        ctx.font = '24px Courier'; ctx.fillText("PWR: " + batteryLevel, 850, 130);
        ctx.strokeRect(850, 140, 120, 15); ctx.fillRect(850, 140, (parseInt(batteryLevel)/100)*120, 15);
        
        // Track Display
        ctx.font = 'bold 40px Courier'; ctx.fillText(currentTrack.substring(0, 22), 450, 220);
        ctx.font = '24px Courier'; ctx.fillText(currentArtist.substring(0, 28), 450, 270);
        
        // Progress
        const progWidth = 500;
        const progress = progressMs / durationMs;
        ctx.strokeRect(450, 320, progWidth, 10);
        ctx.fillRect(450, 320, (progWidth * progress) || 0, 10);

        // Visualizer
        for(let i=0; i<30; i++) {
            let h = Math.random() * 60;
            ctx.fillRect(450 + (i*17), 450 - h, 12, h);
        }
        screenTexture.needsUpdate = true;
    }

    function animate() {
        requestAnimationFrame(animate);
        if(dashReady) { draw(); dashGroup.rotation.y = Math.sin(Date.now() * 0.0004) * 0.05; }
        renderer.render(scene, camera);
    }
    animate();
</script>
</body>
</html>