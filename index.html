<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BAT-OS V5 | COMMAND CENTER</title>
    <style>
        :root { --glow: #ff3c00; --bg: #000; }
        body { margin: 0; overflow: hidden; background: var(--bg); font-family: 'Courier New', monospace; color: var(--glow); user-select: none; }
        
        #intro { position: fixed; inset: 0; z-index: 1000; cursor: pointer; display: flex; justify-content: center; align-items: center; }
        .door { position: absolute; top: 0; height: 100%; width: 50.5%; background: #050505; border: 1px solid #111; transition: transform 2s cubic-bezier(0.8, 0, 0.2, 1); z-index: 1001; }
        #left-door { left: 0; } #right-door { right: 0; }
        .open #left-door { transform: translateX(-100%); }
        .open #right-door { transform: translateX(100%); }

        #scan-box { display: none; position: relative; z-index: 1002; text-align: center; }
        #laser { width: 250px; height: 3px; background: var(--glow); box-shadow: 0 0 20px var(--glow); position: absolute; animation: moveLaser 1.5s ease-in-out infinite; }
        @keyframes moveLaser { 0%, 100% { top: 0; } 50% { top: 250px; } }

        #hud { position: absolute; inset: 0; pointer-events: none; z-index: 10; opacity: 0; transition: opacity 1.5s; }
        canvas { display: block; }
        #screenContent { display: none; }
    </style>
</head>
<body>

<div id="intro">
    <div id="left-door" class="door"></div>
    <div id="right-door" class="door"></div>
    <div id="scan-box">
        <div id="laser"></div>
        <p style="margin-top:280px; font-weight: bold; letter-spacing: 5px;" id="auth-status">LINKING SATELLITE...</p>
    </div>
    <div id="tap-msg" style="z-index:1003; font-size: 18px; border: 1px solid var(--glow); padding: 10px 20px;">INITIATE COMMAND</div>
</div>

<div id="hud">
    <div style="position:absolute; top:20px; left:30px; font-size:12px;">ENCRYPTED AUDIO LINK: ESTABLISHED</div>
</div>

<canvas id="screenContent" width="512" height="512"></canvas>

<script type="importmap">
  { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
</script>

<script type="module">
    import * as THREE from 'three';

    // --- SPOTIFY CORE ---
    const CLIENT_ID = '2a31097ec0e64dc99ba46002bac64623';
    const REDIRECT_URI = window.location.origin + window.location.pathname;
    const SCOPES = 'user-read-currently-playing user-modify-playback-state';

    let spotifyToken = null;
    let currentTrack = "SYSTEM STANDBY";
    let currentArtist = "SCANNING FOR MEDIA";

    // --- AUTH & API CALLS ---
    function login() {
        const url = `https://accounts.spotify.com/authorize?client_id=${CLIENT_ID}&response_type=token&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=${encodeURIComponent(SCOPES)}`;
        window.location.href = url;
    }

    function getToken() {
        const hash = window.location.hash.substring(1).split('&').reduce((initial, item) => {
            if (item) { var parts = item.split('='); initial[parts[0]] = decodeURIComponent(parts[1]); }
            return initial;
        }, {});
        window.location.hash = "";
        return hash.access_token;
    }

    async function spotifyCmd(cmd) {
        if(!spotifyToken) return;
        const method = (cmd === 'next' || cmd === 'previous') ? 'POST' : 'PUT';
        try {
            await fetch(`https://api.spotify.com/v1/me/player/${cmd}`, {
                method: method,
                headers: { 'Authorization': `Bearer ${spotifyToken}` }
            });
            setTimeout(updateInfo, 500); // Refresh UI after command
        } catch(e) { console.log("Spotify Cmd Error"); }
    }

    async function updateInfo() {
        if (!spotifyToken) return;
        const res = await fetch('https://api.spotify.com/v1/me/player/currently-playing', {
            headers: { 'Authorization': `Bearer ${spotifyToken}` }
        });
        if (res.status === 200) {
            const data = await res.json();
            currentTrack = data.item.name.toUpperCase();
            currentArtist = data.item.artists[0].name.toUpperCase();
        }
    }

    // --- STARTUP LOGIC ---
    const token = getToken();
    let dashReady = false;
    if (token) {
        spotifyToken = token;
        dashReady = true;
        document.getElementById('intro').style.display = 'none';
        document.getElementById('hud').style.opacity = 1;
        setInterval(updateInfo, 3000);
    }

    document.getElementById('intro').onclick = () => {
        document.getElementById('tap-msg').style.display = 'none';
        document.getElementById('intro').classList.add('open');
        document.getElementById('scan-box').style.display = 'block';
        document.getElementById('scan-box').style.opacity = 1;
        setTimeout(login, 4000);
    };

    // --- THREE.JS VISUALS ---
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(50, window.innerWidth/window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    const dashGroup = new THREE.Group();
    scene.add(dashGroup);

    // Screen
    const screenCanvas = document.getElementById('screenContent');
    const ctx = screenCanvas.getContext('2d');
    const screenTexture = new THREE.CanvasTexture(screenCanvas);
    const monitor = new THREE.Mesh(new THREE.PlaneGeometry(6, 4), new THREE.MeshStandardMaterial({ map: screenTexture, emissive: 0xff3c00, emissiveIntensity: 0.3 }));
    monitor.position.z = 0.2;
    dashGroup.add(monitor);

    // Buttons
    const buttons = [];
    const controls = [
        { label: '<<', x: -4.5, y: 1.5, cmd: 'previous' },
        { label: '||', x: -4.5, y: 0, cmd: 'pause' }, // Use 'play' or 'pause' logic
        { label: '>>', x: -4.5, y: -1.5, cmd: 'next' }
    ];

    controls.forEach(cfg => {
        const btn = new THREE.Mesh(new THREE.BoxGeometry(1.5, 1, 0.3), new THREE.MeshStandardMaterial({ color: 0x111111, emissive: 0xff3c00, emissiveIntensity: 0.2 }));
        btn.position.set(cfg.x, cfg.y, 0.3);
        
        // Text Label for button
        const lCanvas = document.createElement('canvas');
        lCanvas.width = 64; lCanvas.height = 64;
        const lCtx = lCanvas.getContext('2d');
        lCtx.fillStyle = '#ff3c00'; lCtx.font = 'bold 30px Arial'; lCtx.textAlign = 'center';
        lCtx.fillText(cfg.label, 32, 42);
        const lTex = new THREE.CanvasTexture(lCanvas);
        const labelMesh = new THREE.Mesh(new THREE.PlaneGeometry(0.8, 0.8), new THREE.MeshBasicMaterial({ map: lTex, transparent: true }));
        labelMesh.position.set(cfg.x, cfg.y, 0.46);

        btn.userData = { cmd: cfg.cmd };
        buttons.push(btn);
        dashGroup.add(btn, labelMesh);
    });

    scene.add(new THREE.PointLight(0xff3c00, 20, 20));
    camera.position.z = 10;

    // --- INTERACTION ---
    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();
    window.addEventListener('pointerdown', (e) => {
        if(!dashReady) return;
        mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
        mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
        raycaster.setFromCamera(mouse, camera);
        const hit = raycaster.intersectObjects(buttons);
        if(hit.length > 0) {
            const b = hit[0].object;
            b.position.z = 0.1;
            spotifyCmd(b.userData.cmd);
            setTimeout(() => b.position.z = 0.3, 200);
        }
    });

    function draw() {
        ctx.fillStyle = 'black'; ctx.fillRect(0, 0, 512, 512);
        ctx.strokeStyle = '#ff3c00'; ctx.lineWidth = 4; ctx.strokeRect(20, 20, 472, 472);
        ctx.fillStyle = '#ff3c00';
        ctx.font = 'bold 30px Courier'; ctx.fillText("WAYNETECH TACTICAL AUDIO", 60, 80);
        ctx.font = '20px Courier'; ctx.fillText("STATUS: ACTIVE", 60, 120);
        ctx.font = 'bold 35px Courier'; ctx.fillText(currentTrack.substring(0, 18), 60, 250);
        ctx.font = '22px Courier'; ctx.fillText(currentArtist.substring(0, 22), 60, 300);
        
        // Fake Waveform
        for(let i=0; i<30; i++) {
            let h = Math.random() * 60;
            ctx.fillRect(60 + (i*13), 450 - h, 8, h);
        }
        screenTexture.needsUpdate = true;
    }

    function animate() {
        requestAnimationFrame(animate);
        if(dashReady) {
            draw();
            dashGroup.rotation.y = Math.sin(Date.now() * 0.0005) * 0.1;
        }
        renderer.render(scene, camera);
    }
    animate();
</script>
</body>
</html>