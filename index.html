<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BAT-OS | TERMINAL V5.5</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <style>
        :root { --glow: #ff3c00; --bg: #000; }
        body { margin: 0; overflow: hidden; background: var(--bg); font-family: 'Courier New', monospace; color: var(--glow); user-select: none; }
        
        #intro { position: fixed; inset: 0; z-index: 1000; cursor: pointer; display: flex; justify-content: center; align-items: center; background: #000; }
        .door { position: absolute; top: 0; height: 100%; width: 50.5%; background: #050505; border: 1px solid #111; transition: transform 2s cubic-bezier(0.8, 0, 0.2, 1); z-index: 1001; }
        #left-door { left: 0; } #right-door { right: 0; }
        .open #left-door { transform: translateX(-100%); }
        .open #right-door { transform: translateX(100%); }

        #scan-box { display: none; position: relative; z-index: 1002; text-align: center; }
        #laser { width: 250px; height: 3px; background: var(--glow); box-shadow: 0 0 20px var(--glow); position: absolute; animation: moveLaser 1.5s ease-in-out infinite; }
        @keyframes moveLaser { 0%, 100% { top: 0; } 50% { top: 250px; } }

        #hud { position: absolute; inset: 0; pointer-events: none; z-index: 10; opacity: 0; transition: opacity 1.5s; }
        canvas { display: block; }
        #screenContent { display: none; }
    </style>
</head>
<body>

<div id="intro">
    <div id="left-door" class="door"></div>
    <div id="right-door" class="door"></div>
    <div id="scan-box">
        <div id="laser"></div>
        <p style="margin-top:280px; font-weight: bold; letter-spacing: 5px;" id="auth-status">LINKING...</p>
    </div>
    <div id="tap-msg" style="z-index:1003; font-size: 18px; border: 1px solid var(--glow); padding: 10px 20px;">[ INITIATE BOOT ]</div>
</div>

<div id="hud">
    <div style="position:absolute; top:20px; left:30px; font-size:12px;">STATUS: ENCRYPTED</div>
</div>

<canvas id="screenContent" width="512" height="512"></canvas>

<script type="importmap">
  { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }
</script>

<script type="module">
    import * as THREE from 'three';

    const CLIENT_ID = '2a31097ec0e64dc99ba46002bac64623';
    const REDIRECT_URI = 'https://belisario-afk.github.io/Bat-OS/'; 
    const SCOPES = 'user-read-currently-playing user-modify-playback-state';

    let spotifyToken = localStorage.getItem('bat_os_token');
    let currentTrack = "SYSTEM IDLE";
    let currentArtist = "WAITING...";
    let batteryLevel = "0%";
    let dashReady = false;

    // --- STEP 1: TOKEN CAPTURE (Runs immediately before anything else) ---
    function captureToken() {
        const urlParams = new URLSearchParams(window.location.hash.substring(1));
        const token = urlParams.get('access_token');
        
        if (token) {
            localStorage.setItem('bat_os_token', token);
            spotifyToken = token;
            // Clear hash from URL to prevent loop
            window.history.replaceState(null, null, window.location.pathname);
            return true;
        }
        return false;
    }

    // --- STEP 2: AUTH TRIGGER ---
    function startAuth() {
        localStorage.removeItem('bat_os_token'); // Purge old data
        const authUrl = `https://accounts.spotify.com/authorize?client_id=${CLIENT_ID}&response_type=token&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=${encodeURIComponent(SCOPES)}&show_dialog=true`;
        window.location.href = authUrl;
    }

    // --- STEP 3: API CALLS ---
    async function spotifyAction(endpoint, method = 'POST') {
        if(!spotifyToken) return;
        try {
            const res = await fetch(`https://api.spotify.com/v1/me/player/${endpoint}`, {
                method: method,
                headers: { 'Authorization': `Bearer ${spotifyToken}` }
            });
            if (res.status === 401) startAuth(); // Token invalid/expired
            setTimeout(updateDisplay, 500);
        } catch(e) {}
    }

    async function updateDisplay() {
        if (!spotifyToken) return;
        try {
            const res = await fetch('https://api.spotify.com/v1/me/player/currently-playing', {
                headers: { 'Authorization': `Bearer ${spotifyToken}` }
            });
            if (res.status === 200) {
                const data = await res.json();
                if (data.item) {
                    currentTrack = data.item.name.toUpperCase();
                    currentArtist = data.item.artists[0].name.toUpperCase();
                }
            } else if (res.status === 401) {
                startAuth();
            }
        } catch(e) {}
    }

    // --- STEP 4: INITIALIZE DASHBOARD ---
    captureToken();

    if (spotifyToken) {
        dashReady = true;
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('intro').style.display = 'none';
            document.getElementById('hud').style.opacity = 1;
            setInterval(updateDisplay, 4000);
            updateDisplay();
        });
    }

    // --- DASHBOARD UI & VISUALS ---
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(50, window.innerWidth/window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    const dashGroup = new THREE.Group();
    scene.add(dashGroup);

    const screenCanvas = document.getElementById('screenContent');
    const ctx = screenCanvas.getContext('2d');
    const screenTexture = new THREE.CanvasTexture(screenCanvas);
    const monitor = new THREE.Mesh(new THREE.PlaneGeometry(6, 4), new THREE.MeshStandardMaterial({ map: screenTexture, emissive: 0xff3c00, emissiveIntensity: 0.3 }));
    monitor.position.z = 0.2;
    dashGroup.add(monitor);

    const buttons = [];
    const controls = [{ sym: '|<', x: -4.5, y: 1.5, cmd: 'previous' }, { sym: '||', x: -4.5, y: 0, cmd: 'pause' }, { sym: '>|', x: -4.5, y: -1.5, cmd: 'next' }];

    controls.forEach(cfg => {
        const btn = new THREE.Mesh(new THREE.BoxGeometry(1.6, 1.1, 0.3), new THREE.MeshStandardMaterial({ color: 0x111111, emissive: 0xff3c00, emissiveIntensity: 0.2 }));
        btn.position.set(cfg.x, cfg.y, 0.3);
        const lCanvas = document.createElement('canvas'); lCanvas.width = 128; lCanvas.height = 128;
        const lCtx = lCanvas.getContext('2d'); lCtx.fillStyle = '#ff3c00'; lCtx.font = 'bold 50px Arial'; lCtx.textAlign = 'center'; lCtx.fillText(cfg.sym, 64, 85);
        const labelMesh = new THREE.Mesh(new THREE.PlaneGeometry(0.8, 0.8), new THREE.MeshBasicMaterial({ map: new THREE.CanvasTexture(lCanvas), transparent: true }));
        labelMesh.position.set(cfg.x, cfg.y, 0.46);
        btn.userData = { cmd: cfg.cmd }; buttons.push(btn); dashGroup.add(btn, labelMesh);
    });

    scene.add(new THREE.PointLight(0xff3c00, 25, 20));
    camera.position.z = 10;

    // Interaction
    window.addEventListener('pointerdown', (e) => {
        if (!dashReady) {
            // Handle Intro Click
            document.getElementById('tap-msg').style.display = 'none';
            document.getElementById('intro').classList.add('open');
            document.getElementById('scan-box').style.display = 'block';
            document.getElementById('scan-box').style.opacity = 1;
            setTimeout(startAuth, 3500);
            return;
        }
        
        const mouse = new THREE.Vector2((e.clientX / window.innerWidth) * 2 - 1, -(e.clientY / window.innerHeight) * 2 + 1);
        const raycaster = new THREE.Raycaster();
        raycaster.setFromCamera(mouse, camera);
        const hit = raycaster.intersectObjects(buttons);
        if(hit.length > 0) {
            const b = hit[0].object; b.position.z = 0.1;
            spotifyAction(b.userData.cmd, b.userData.cmd === 'pause' ? 'PUT' : 'POST');
            setTimeout(() => b.position.z = 0.3, 150);
        }
    });

    // Battery
    if (navigator.getBattery) { navigator.getBattery().then(batt => { 
        batteryLevel = Math.floor(batt.level * 100) + "%";
        batt.onlevelchange = () => batteryLevel = Math.floor(batt.level * 100) + "%";
    }); }

    function draw() {
        ctx.fillStyle = 'black'; ctx.fillRect(0, 0, 512, 512);
        ctx.strokeStyle = '#ff3c00'; ctx.lineWidth = 4; ctx.strokeRect(20, 20, 472, 472);
        ctx.fillStyle = '#ff3c00';
        ctx.font = 'bold 28px Courier'; ctx.fillText("WAYNETECH TACTICAL AUDIO", 60, 80);
        ctx.font = '20px Courier'; ctx.fillText("PWR: " + batteryLevel, 360, 120);
        ctx.strokeRect(360, 130, 100, 15); ctx.fillRect(360, 130, parseInt(batteryLevel) || 0, 15);
        ctx.font = 'bold 32px Courier'; ctx.fillText(currentTrack.substring(0, 20), 60, 240);
        ctx.font = '24px Courier'; ctx.fillText(currentArtist.substring(0, 22), 60, 290);
        for(let i=0; i<25; i++) { let h = Math.random() * 80; ctx.fillRect(60 + (i*15), 450 - h, 10, h); }
        screenTexture.needsUpdate = true;
    }

    function animate() {
        requestAnimationFrame(animate);
        if(dashReady) { draw(); dashGroup.rotation.y = Math.sin(Date.now() * 0.0004) * 0.08; }
        renderer.render(scene, camera);
    }
    animate();
</script>
</body>
</html>